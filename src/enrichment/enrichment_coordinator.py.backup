"""Enrichment coordinator that orchestrates the complete Snov.io integration workflow.

This module coordinates between streaming API, queue processing, and Snov.io integration
to provide end-to-end lead enrichment functionality.
"""

import logging
from typing import Any, Optional

from streaming.company_state_manager import CompanyStateManager
from streaming.queue_manager import PriorityQueueManager
from .credit_manager import CreditManager
from .dependency_manager import DependencyManager
from .queue_processor import SnovQueueProcessor
from .snov_client import SnovioClient
from .streaming_integration import StreamingIntegration
from .webhook_handler import WebhookHandler

logger = logging.getLogger(__name__)


class EnrichmentCoordinatorError(Exception):
    """Raised when coordinator operations fail."""

    pass


class EnrichmentCoordinator:
    """Coordinates the complete enrichment workflow.

    This coordinator brings together all the components needed for the
    streaming API â†’ Snov.io enrichment workflow to function end-to-end.
    """

    def __init__(self, database_path: str = "companies.db") -> None:
        """Initialize the enrichment coordinator.

        Args:
            database_path: Path to SQLite database
        """
        self.database_path = database_path

        # Core components
        self.queue_manager: Optional[PriorityQueueManager] = None
        self.company_state_manager: Optional[CompanyStateManager] = None
        self.snov_client: Optional[SnovioClient] = None
        self.dependency_manager: Optional[DependencyManager] = None
        self.streaming_integration: Optional[StreamingIntegration] = None
        self.queue_processor: Optional[SnovQueueProcessor] = None
        self.credit_manager: Optional[CreditManager] = None
        self.webhook_handler: Optional[WebhookHandler] = None

        # Control
        self._initialized = False
        self._running = False

    async def initialize(self) -> None:
        """Initialize all components."""
        if self._initialized:
            return

        logger.info("Initializing enrichment coordinator")

        try:
            # Initialize core components in dependency order
            self.queue_manager = PriorityQueueManager(max_queue_size=10000, enable_monitoring=True)

            self.company_state_manager = CompanyStateManager(
                database_path=self.database_path, queue_manager=self.queue_manager
            )
            await self.company_state_manager.initialize()

            # Initialize Snov.io client
            self.snov_client = SnovioClient()

            # Initialize dependency manager
            self.dependency_manager = DependencyManager(
                company_state_manager=self.company_state_manager,
                queue_manager=self.queue_manager,
                database_path=self.database_path,
            )

            # Initialize credit manager (optional)
            try:
                self.credit_manager = CreditManager(database_path=self.database_path)
                # Credit manager doesn't have initialize method
            except Exception as e:
                logger.warning(f"Credit manager initialization failed: {e}")
                self.credit_manager = None

            # Initialize webhook handler (optional)
            try:
                self.webhook_handler = WebhookHandler(
                    database_path=self.database_path,
                    webhook_secret="default_secret",  # TODO: Get from config
                )
                # Webhook handler doesn't have initialize method
            except Exception as e:
                logger.warning(f"Webhook handler initialization failed: {e}")
                self.webhook_handler = None

            # Initialize streaming integration bridge
            self.streaming_integration = StreamingIntegration(
                company_state_manager=self.company_state_manager,
                queue_manager=self.queue_manager,
                credit_manager=self.credit_manager,
                snov_client=self.snov_client,
                webhook_handler=self.webhook_handler,
                database_path=self.database_path,
            )
            await self.streaming_integration.initialize()

            # Initialize queue processor
            self.queue_processor = SnovQueueProcessor(
                queue_manager=self.queue_manager,
                snov_client=self.snov_client,
                dependency_manager=self.dependency_manager,
                streaming_integration=self.streaming_integration,
            )

            self._initialized = True
            logger.info("Enrichment coordinator initialized successfully")

        except Exception as e:
            logger.error(f"Failed to initialize enrichment coordinator: {e}")
            raise EnrichmentCoordinatorError(f"Initialization failed: {e}") from e

    async def start_processing(self) -> None:
        """Start all processing components."""
        if not self._initialized:
            await self.initialize()

        if self._running:
            logger.warning("Enrichment coordinator already running")
            return

        logger.info("Starting enrichment coordinator")
        self._running = True

        try:
            # Start queue processor
            if self.queue_processor:
                await self.queue_processor.start_processing()
            else:
                raise EnrichmentCoordinatorError("Queue processor not initialized")

        except Exception as e:
            logger.error(f"Failed to start enrichment coordinator: {e}")
            self._running = False
            raise

    async def stop_processing(self) -> None:
        """Stop all processing components."""
        if not self._running:
            return

        logger.info("Stopping enrichment coordinator")

        # Stop queue processor
        if self.queue_processor:
            await self.queue_processor.stop_processing()

        self._running = False
        logger.info("Enrichment coordinator stopped")

    async def process_strike_off_company(self, company_number: str, company_name: str) -> bool:
        """Process a newly detected strike-off company for enrichment.

        Args:
            company_number: Companies House company number
            company_name: Company name

        Returns:
            True if enrichment was initiated successfully
        """
        if not self._initialized:
            await self.initialize()

        if not self.streaming_integration:
            raise EnrichmentCoordinatorError("Streaming integration not initialized")

        return await self.streaming_integration.handle_strike_off_company_enrichment(
            company_number=company_number, company_name=company_name
        )

    def get_status(self) -> dict[str, Any]:
        """Get coordinator status and metrics.

        Returns:
            Status information dictionary
        """
        status = {
            "initialized": self._initialized,
            "running": self._running,
            "components": {
                "queue_manager": self.queue_manager is not None,
                "company_state_manager": self.company_state_manager is not None,
                "snov_client": self.snov_client is not None,
                "dependency_manager": self.dependency_manager is not None,
                "streaming_integration": self.streaming_integration is not None,
                "queue_processor": self.queue_processor is not None,
                "credit_manager": self.credit_manager is not None,
                "webhook_handler": self.webhook_handler is not None,
            },
        }

        # Add component-specific metrics
        if self.queue_processor:
            status["queue_processor_stats"] = self.queue_processor.get_processing_statistics()

        if self.streaming_integration:
            status["integration_stats"] = self.streaming_integration.get_integration_statistics()

        if self.queue_manager:
            status["queue_status"] = self.queue_manager.get_queue_status()

        return status


# Convenience function for testing
async def create_test_coordinator(database_path: str = "companies.db") -> EnrichmentCoordinator:
    """Create and initialize coordinator for testing.

    Args:
        database_path: Path to test database

    Returns:
        Initialized coordinator
    """
    coordinator = EnrichmentCoordinator(database_path=database_path)
    await coordinator.initialize()
    return coordinator
