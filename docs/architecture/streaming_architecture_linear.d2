# Companies House + Snov.io Integration Flow
# Linear representation for stakeholder clarity

direction: down

# Starting Point
start: "Companies House\nStreaming API Event" {
  shape: oval
  style.fill: "#e1f5fe"
  style.stroke: "#0288d1"
  style.stroke-width: 2
}

# Step 1: Status Check (MANDATORY FOR EVERY EVENT)
step1: "1. Check Company Status\n[CH REST API]\nEVERY EVENT REQUIRES THIS" {
  shape: rectangle
  style.fill: "#fce4ec"
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

# Decision: Strike-off?
is_strikeoff: "Strike-off Status?" {
  shape: diamond
  style.fill: "#e8f5e8"
}

# Not strike-off - END
not_strikeoff: "Not Strike-off\nEND PROCESSING\n(No further API calls)" {
  shape: rectangle
  style.fill: "#f5f5f5"
  style.stroke: "#757575"
}

# Step 2: Save Company
step2: "2. Save Company to DB\n(Strike-off detected)" {
  shape: rectangle
  style.fill: "#c8e6c9"
}

# Step 3: Domain Search
step3: "3. Search for Domain\n[Snov.io API - Webhook]\n1 credit consumed" {
  shape: rectangle
  style.fill: "#dcedc8"
  style.stroke: "#558b2f"
}

# Decision: Domain found?
has_domain: "Domain Found?" {
  shape: diamond
  style.fill: "#c5e1a5"
}

# No domain - END
no_domain: "No Domain Found\nEND PROCESSING\n(40-60% filtered here)" {
  shape: rectangle
  style.fill: "#ef9a9a"
  style.stroke: "#c62828"
  style.stroke-width: 2
}

# Step 4: Save Domain
step4: "4. Save Domain to DB" {
  shape: rectangle
  style.fill: "#a5d6a7"
}

# Step 5: Fetch Officers
step5: "5. Fetch Officers\n[CH REST API]" {
  shape: rectangle
  style.fill: "#e1f5fe"
  style.stroke: "#1976d2"
}

# Decision: Officers found?
has_officers: "Officers Found?" {
  shape: diamond
  style.fill: "#bbdefb"
}

# No officers - END
no_officers: "No Officers\nEND PROCESSING" {
  shape: rectangle
  style.fill: "#ffab91"
  style.stroke: "#ff6f00"
}

# Step 6: Save Officers
step6: "6. Save ALL Officers to DB" {
  shape: rectangle
  style.fill: "#90caf9"
}

# Step 7: Email Search Loop
step7: "7. For Each Officer:\nSearch Email\n[Snov.io API - Webhook]\n1 credit per officer" {
  shape: rectangle
  style.fill: "#c8e6c9"
  style.stroke: "#2e7d32"
  style.stroke-width: 2
  style.stroke-dash: 3
}

# Decision: Email found?
has_email: "Email Found?" {
  shape: diamond
  style.fill: "#a5d6a7"
}

# No email
no_email: "No Email\n(Try next officer)" {
  shape: rectangle
  style.fill: "#ffccbc"
  style.stroke: "#ff6f00"
}

# Step 8: Save Emails
step8: "8. Save Email to DB" {
  shape: rectangle
  style.fill: "#81c784"
}

# End Success
end_success: "Processing Complete" {
  shape: oval
  style.fill: "#c8e6c9"
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

# Flow connections
start -> step1: "Queue with\nHIGH priority"
step1 -> is_strikeoff: "600 req/5min limit"
is_strikeoff -> not_strikeoff: "No"
is_strikeoff -> step2: "Yes"
step2 -> step3: "Check credits"
step3 -> has_domain: "Async result"
has_domain -> no_domain: "No"
has_domain -> step4: "Yes"
step4 -> step5
step5 -> has_officers
has_officers -> no_officers: "No"
has_officers -> step6: "Yes"
step6 -> step7
step7 -> has_email: "Per officer"
has_email -> no_email: "No"
has_email -> step8: "Yes"
no_email -> step7: "Loop"
step8 -> step7: "Next officer"
step7 -> end_success: "All done"

# Key Constraints Box
constraints: "System Constraints" {
  shape: rectangle
  style.fill: "#fff9c4"
  style.stroke: "#f57f17"
  style.stroke-dash: 3
  near: top-right
}

constraints_text: |md
  **Bottlenecks:**
  • CH API: 600 req/5min
  • Snov.io: 5000 credits/month

  **Volume Estimates:**
  • 100% events → status check
  • ~5% are strike-offs
  • ~40% have domains
  • ~2% complete full flow
|

# Credits Box
credits: "Credit Usage" {
  shape: rectangle
  style.fill: "#fff59d"
  style.stroke: "#f9a825"
  style.stroke-dash: 3
  near: bottom-right
}

credits_text: |md
  **Per Company:**
  • 1 credit - domain search
  • N credits - email search
    (1 per officer)

  **Monthly Budget:**
  • 5000 credits total
  • ~500-1000 companies
  • Scales to 100k
|
