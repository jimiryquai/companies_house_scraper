# Companies House to Airtable Integration Flow
# Simplified workflow with 3 separate CH Developer Hub applications

direction: down

# Title
title: "Companies House → Airtable Integration\n3 Separate CH Applications" {
  shape: text
  near: top-center
  style.font-size: 24
  style.bold: true
}

# CH Application 1: Streaming API
app1: "CH Dev Hub App #1\nStreaming API" {
  shape: rectangle
  style.fill: "#e3f2fd"
  style.stroke: "#1976d2"
  style.stroke-width: 3
  style.bold: true
}

# Step 1: Listen to Streaming API
step1: "1. Listen for Events\n[Streaming API]\nReal-time company change events" {
  shape: rectangle
  style.fill: "#e1f5fe"
  style.stroke: "#0288d1"
  style.stroke-width: 2
}

# CH Application 2: Companies REST API
app2: "CH Dev Hub App #2\nCompanies REST API" {
  shape: rectangle
  style.fill: "#f3e5f5"
  style.stroke: "#7b1fa2"
  style.stroke-width: 3
  style.bold: true
}

# Step 2: Fetch Company Data
step2: "2. Fetch Company Data\n[Companies REST API]\n600 requests / 5 minutes" {
  shape: rectangle
  style.fill: "#f1f8e9"
  style.stroke: "#558b2f"
  style.stroke-width: 2
}

# Step 3: Create/Update Company in Airtable
step3: "3. Create/Update Company\n[Airtable API]\nUpsert company record" {
  shape: rectangle
  style.fill: "#c8e6c9"
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

# CH Application 3: Officers REST API
app3: "CH Dev Hub App #3\nOfficers REST API" {
  shape: rectangle
  style.fill: "#fff3e0"
  style.stroke: "#e65100"
  style.stroke-width: 3
  style.bold: true
}

# Step 4: Fetch Officers Data
step4: "4. Fetch Officers\n[Officers REST API]\n600 requests / 5 minutes" {
  shape: rectangle
  style.fill: "#ffe0b2"
  style.stroke: "#ef6c00"
  style.stroke-width: 2
}

# Step 5: Create/Update Officers in Airtable
step5: "5. Create/Update Officers\n[Airtable API]\nUpsert officer records" {
  shape: rectangle
  style.fill: "#ffccbc"
  style.stroke: "#d84315"
  style.stroke-width: 2
}

# End Success
end_success: "Processing Complete" {
  shape: oval
  style.fill: "#c8e6c9"
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

# Flow connections
app1 -> step1: "Uses"
step1 -> step2: "Event received\n(company number)"
app2 -> step2: "Uses"
step2 -> step3: "Company data\nretrieved"
step3 -> step4: "Company stored\nin Airtable"
app3 -> step4: "Uses"
step4 -> step5: "Officers data\nretrieved"
step5 -> end_success: "Officers stored\nin Airtable"

# Rate Limits Box
rate_limits: "Rate Limits & Applications" {
  shape: rectangle
  style.fill: "#fff9c4"
  style.stroke: "#f57f17"
  style.stroke-width: 2
  near: top-right
}

rate_limits.text: |md
  **3 Separate CH Applications:**

  **App #1: Streaming**
  • Real-time event stream
  • No rate limit concerns

  **App #2: Companies API**
  • 600 requests / 5 minutes
  • Independent rate limit

  **App #3: Officers API**
  • 600 requests / 5 minutes
  • Independent rate limit

  **Benefit:** Each API has its own
  600 req/5min limit = 1800 total
|

# Workflow Summary Box
workflow_summary: "Workflow Summary" {
  shape: rectangle
  style.fill: "#e8f5e9"
  style.stroke: "#2e7d32"
  style.stroke-width: 2
  near: bottom-right
}

workflow_summary.text: |md
  **Per Event Flow:**

  1. **Streaming API** detects change
  2. **Companies API** fetches data
  3. **Airtable** upsert company
  4. **Officers API** fetches officers
  5. **Airtable** upsert officers

  **Storage:** Airtable (no local DB)

  **Simplicity:** Direct API → Airtable
  No enrichment, no filtering
|

# Airtable Box
airtable: "Airtable Storage" {
  shape: cylinder
  style.fill: "#fff3e0"
  style.stroke: "#ff6f00"
  style.stroke-width: 2
  near: bottom-left
}

airtable.text: |md
  **Tables:**
  • Companies
  • Officers

  **Operations:**
  • Create if new
  • Update if exists
  • Link officers to companies
|
