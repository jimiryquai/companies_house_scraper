# Companies House Streaming Architecture - Hybrid System

# External APIs
streaming_api: "Companies House\nStreaming API" {
  shape: cloud
  style.fill: "#e1f5fe"
}

rest_api: "Companies House\nREST API" {
  shape: cloud
  style.fill: "#e1f5fe"
}

# Main Service
streaming_service: "StreamingService\n(Main Controller)" {
  shape: hexagon
  style.fill: "#fff3e0"
}

# Processing Components
rest_call: "REST API Call\nGET /company/{number}" {
  shape: rectangle
  style.fill: "#f3e5f5"
}

status_check: "Check Detailed Status\ncompany_status_detail" {
  shape: diamond
  style.fill: "#e8f5e8"
}

# Decision Paths
strike_off_detected: "Strike-off Detected\n'Active - Proposal to Strike Off'" {
  shape: rectangle
  style.fill: "#c8e6c9"
}

non_strike_off: "Non-strike-off Status\n'active', 'dissolved', etc" {
  shape: rectangle
  style.fill: "#ffecb3"
}

# Database Checks
db_check_new: "Company in\nDatabase?" {
  shape: diamond
  style.fill: "#e3f2fd"
}

db_check_cleanup: "Company in\nDatabase?" {
  shape: diamond
  style.fill: "#e3f2fd"
}

# Actions
new_company: "New Strike-off Company\nFetch Officers" {
  shape: rectangle
  style.fill: "#c8e6c9"
}

already_tracked: "Already Tracked\nLog: Monitoring" {
  shape: rectangle
  style.fill: "#fff9c4"
}

company_left: "Company Left Strike-off\nCleanup Records" {
  shape: rectangle
  style.fill: "#ffecb3"
}

ignore_company: "Regular Company\nIgnore" {
  shape: rectangle
  style.fill: "#f5f5f5"
}

# Officer Import
officer_api: "Fetch Officers\nREST API Call" {
  shape: rectangle
  style.fill: "#e1f5fe"
}

# Database
database: "SQLite Database" {
  shape: cylinder
  style.fill: "#f3e5f5"

  companies_table: "companies table\n- company_number\n- company_status_detail\n- stream_last_updated"
  officers_table: "officers table\n- company_number\n- officer_role\n- name"
}

# Flow connections
streaming_api -> streaming_service: "Real-time events\n(basic status only)"
streaming_service -> rest_call: "Extract company_number"
rest_call -> rest_api: "GET detailed data"
rest_api -> status_check: "Returns company_status_detail"

status_check -> strike_off_detected: "Contains 'proposal to strike off'"
status_check -> non_strike_off: "Regular status"

strike_off_detected -> db_check_new: "Check if new"
db_check_new -> new_company: "Not in DB"
db_check_new -> already_tracked: "Already in DB"

non_strike_off -> db_check_cleanup: "Check if needs cleanup"
db_check_cleanup -> company_left: "In DB (was strike-off)"
db_check_cleanup -> ignore_company: "Not in DB"

new_company -> officer_api: "Fetch officers"
officer_api -> rest_api: "GET /company/{number}/officers"
officer_api -> database.officers_table: "Save officers"
new_company -> database.companies_table: "Save company"

company_left -> database.companies_table: "Mark as 'Left strike-off status'"

# Stats and monitoring
streaming_service.stats: "Statistics\n- companies_processed\n- officers_imported\n- cleanup_operations\n- errors" {
  shape: oval
  style.fill: "#f0f4ff"
}

# Legend
legend: "Legend" {
  shape: rectangle
  style.fill: "#ffffff"
  style.stroke: "#000000"
  style.stroke-width: 2

  api_legend: "APIs" {
    style.fill: "#e1f5fe"
  }

  processing_legend: "Processing" {
    style.fill: "#f3e5f5"
  }

  decision_legend: "Decisions" {
    style.fill: "#e8f5e8"
  }

  database_legend: "Database" {
    style.fill: "#f3e5f5"
  }
}
